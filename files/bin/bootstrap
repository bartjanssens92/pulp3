#!/bin/bash
set -e

cd /opt/pulp

python3 -mvenv venv
source venv/bin/activate

python3 -mpip install pulpcore
export DJANGO_SETTINGS_MODULE=pulpcore.app.settings
export PULP_SETTINGS=/etc/pulp/settings.py

django-admin migrate --noinput
django-admin reset-admin-password --password admin
django-admin collectstatic --noinput

sed -i 's/include-system-site-packages = false/include-system-site-packages = true/g' /opt/pulp/venv/pyvenv.cfg
python3 -mpip install scikit-build nose
python3 -mpip install pulp-rpm
django-admin migrate rpm

# Add the puppet configured settings to the app
# as the workers don't read the configfile (yet?)
#cat /etc/pulp/settings.py >> /opt/pulp/pulpcore/pulpcore/app/settings.py

systemctl start pulpcore-api
systemctl start pulpcore-content
systemctl start pulpcore-resource-manager
systemctl start pulpcore-worker@1
systemctl start pulpcore-worker@2
