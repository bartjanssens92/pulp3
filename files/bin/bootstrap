#!/bin/bash
set -e

cd /opt/pulp

python36 -m venv pulpvenv
source pulpvenv/bin/activate

git clone https://github.com/pulp/pulpcore.git
pip install -e ./pulpcore
git clone https://github.com/pulp/pulpcore-plugin.git
pip install -e ./pulpcore-plugin/
pip install psycopg2-binary

pulp-manager migrate --noinput
pulp-manager reset-admin-password --password admin
pulp-manager collectstatic --noinput

git clone https://github.com/pulp/pulp_rpm.git
pip install -e ./pulp_rpm

pulp-manager makemigrations rpm
pulp-manager migrate rpm

# Add the puppet configured settings to the app
# as the workers don't read the configfile (yet?)
cat /etc/pulp/settings.py >> /opt/pulp/pulpcore/pulpcore/app/settings.py

systemctl start pulp-server
systemctl start pulp-resource-manager
systemctl start pulp-worker@1
systemctl start pulp-worker@2
systemctl start pulp-rpm-gunicorn
