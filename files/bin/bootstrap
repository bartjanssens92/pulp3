#!/bin/bash
set -e

cd /opt/pulp

python36 -m venv pulpvenv
source pulpvenv/bin/activate

git clone https://github.com/pulp/pulpcore.git
pip install -e ./pulpcore[postgres]
git clone https://github.com/pulp/pulpcore-plugin.git
pip install -e ./pulpcore-plugin/
pip install psycopg2-binary

/opt/pulp/pulpcore/pulpcore/app/manage.py migrate --noinput
/opt/pulp/pulpcore/pulpcore/app/manage.py reset-admin-password --password admin
/opt/pulp/pulpcore/pulpcore/app/manage.py collectstatic --noinput

git clone https://github.com/pulp/pulp_rpm.git
pip install -e ./pulp_rpm

/opt/pulp/pulpcore/pulpcore/app/manage.py makemigrations rpm
/opt/pulp/pulpcore/pulpcore/app/manage.py migrate rpm

# Add the puppet configured settings to the app
# as the workers don't read the configfile (yet?)
cat /etc/pulp/settings.py >> /opt/pulp/pulpcore/pulpcore/app/settings.py

systemctl start pulp-server
systemctl start pulp-resource-manager
systemctl start pulp-worker@1
systemctl start pulp-worker@2
systemctl start pulp-rpm-gunicorn
